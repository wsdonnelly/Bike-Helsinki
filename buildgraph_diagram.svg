<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1400" viewBox="0 0 1200 1400">
  <defs>
    <style>
      .title { font: 700 26px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif; fill: #111; }
      .subtitle { font: 600 18px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif; fill: #222; }
      .label { font: 500 15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif; fill: #111; }
      .mono { font: 500 14px/1.3 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; fill: #222; }
      .box { fill: #fff; stroke: #1f6feb; stroke-width: 2; rx: 10; }
      .box-muted { fill: #fff; stroke: #8b949e; stroke-width: 1.5; rx: 8; }
      .box-green { fill: #ecfdf5; stroke: #059669; stroke-width: 2; rx: 10; }
      .box-orange { fill: #fff7ed; stroke: #f97316; stroke-width: 2; rx: 10; }
      .small { fill: #f8fafc; stroke: #94a3b8; stroke-width: 1.2; rx: 6; }
      .note { font: 500 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Liberation Sans", sans-serif; fill: #374151; }
      .arrow { stroke: #6b7280; stroke-width: 2.5; marker-end: url(#arrowhead); fill: none; }
      .arrow-curve { stroke: #6b7280; stroke-width: 2.5; marker-end: url(#arrowhead); fill: none; }
      .chip { fill: #eef2ff; stroke: #6366f1; stroke-width: 1; rx: 6; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7"
            refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="40" y="48" class="title">buildGraph.cpp – Ingest → CSR + Blob Formats</text>

  <!-- Section 1: Pipeline -->
  <text x="40" y="90" class="subtitle">1) Ingest → CSR pipeline</text>

  <!-- Row 1 -->
  <rect x="40" y="120" width="170" height="80" class="box-orange"/>
  <text x="125" y="152" text-anchor="middle" class="label">OSM PBF</text>
  <text x="125" y="172" text-anchor="middle" class="mono">input (*.osm.pbf)</text>

  <rect x="250" y="120" width="230" height="120" class="box"/>
  <text x="365" y="150" text-anchor="middle" class="label">WayCollector</text>
  <text x="265" y="170" class="mono">• Filter bike/foot-relevant ways</text>
  <text x="265" y="188" class="mono">• Read tags: highway, access, bicycle, foot,</text>
  <text x="265" y="206" class="mono"> oneway, oneway:bicycle, cycleway, surface</text>
  <text x="265" y="224" class="mono">• Produce WayMeta: mode directions + surface</text>

  <line x1="210" y1="160" x2="250" y2="160" class="arrow"/>

  <rect x="520" y="120" width="230" height="120" class="box"/>
  <text x="635" y="150" text-anchor="middle" class="label">NodeCollector</text>
  <text x="535" y="170" class="mono">• Collect coords only for used node IDs</text>
  <text x="535" y="188" class="mono">• (lat, lon) in float32 degrees</text>

  <line x1="480" y1="180" x2="520" y2="180" class="arrow"/>

  <rect x="790" y="120" width="360" height="120" class="box"/>
  <text x="970" y="150" text-anchor="middle" class="label">Indexing</text>
  <text x="805" y="170" class="mono">• Sort unique node IDs ⇒ allNodeIds[N]</text>
  <text x="805" y="188" class="mono">• Map nodeId → idx (0..N-1)</text>
  <text x="805" y="206" class="mono">• Count directed edges per WayMeta</text>

  <line x1="750" y1="180" x2="790" y2="180" class="arrow"/>

  <!-- Row 2 -->
  <rect x="40" y="270" width="520" height="120" class="box"/>
  <text x="300" y="300" text-anchor="middle" class="label">Build CSR (directed)</text>
  <text x="55" y="320" class="mono">• Prefix-sum degrees ⇒ offsets[N+1]</text>
  <text x="55" y="338" class="mono">• For each allowed direction on each way segment:</text>
  <text x="75" y="356" class="mono">neighbors[E], length_m[E] (haversine)</text>
  <text x="75" y="374" class="mono">surface_flags[E], surface_primary[E], mode_mask[E]</text>

  <line x1="970" y1="240" x2="300" y2="270" class="arrow-curve"/>
  
  <rect x="600" y="270" width="250" height="120" class="box-green"/>
  <text x="725" y="300" text-anchor="middle" class="label">Write graph_nodes.bin</text>
  <text x="615" y="322" class="mono">Header → ids[N] → lat[N] → lon[N]</text>
  <text x="615" y="342" class="mono">float32 degrees (coord_type=0)</text>

  <rect x="880" y="270" width="270" height="120" class="box-green"/>
  <text x="1015" y="300" text-anchor="middle" class="label">Write graph_edges.bin</text>
  <text x="895" y="322" class="mono">Header (flags on) + lengths block</text>
  <text x="895" y="342" class="mono">offsets → neighbors → length_m →</text>
  <text x="895" y="362" class="mono">surface_flags → surface_primary → mode_mask</text>

  <line x1="560" y1="330" x2="600" y2="330" class="arrow"/>
  <line x1="850" y1="330" x2="880" y2="330" class="arrow"/>

  <!-- Separator -->
  <rect x="40" y="420" width="1120" height="1" fill="#e5e7eb"/>

  <!-- Section 2: Blobs -->
  <text x="40" y="460" class="subtitle">2) On-disk blob formats</text>

  <!-- Nodes blob -->
  <rect x="40" y="490" width="520" height="360" class="box-muted"/>
  <text x="300" y="520" text-anchor="middle" class="label">graph_nodes.bin</text>

  <rect x="60" y="540" width="480" height="70" class="small"/>
  <text x="70" y="565" class="mono">NodesHeader (20B)</text>
  <text x="70" y="585" class="mono">magic="MMAPNODE" • version=u32=1 • num_nodes=u32=N • coord_type=u8=0</text>

  <rect x="60" y="625" width="480" height="55" class="small"/>
  <text x="70" y="655" class="mono">ids[N] • u64 each</text>

  <rect x="60" y="690" width="480" height="55" class="small"/>
  <text x="70" y="720" class="mono">lat[N] • float32 degrees</text>

  <rect x="60" y="755" width="480" height="55" class="small"/>
  <text x="70" y="785" class="mono">lon[N] • float32 degrees</text>

  <!-- Edges blob -->
  <rect x="600" y="490" width="560" height="520" class="box-muted"/>
  <text x="880" y="520" text-anchor="middle" class="label">graph_edges.bin</text>

  <rect x="620" y="540" width="520" height="90" class="small"/>
  <text x="630" y="565" class="mono">EdgesHeader (24B)</text>
  <text x="630" y="585" class="mono">magic="MMAPEDGE" • version=u32=1 • num_nodes=u32=N • num_edges=u32=E</text>
  <text x="630" y="605" class="mono">has_surface_primary=1 • has_surface_flags=1 • has_mode_mask=1 • length_type=0</text>

  <rect x="620" y="640" width="520" height="55" class="small"/>
  <text x="630" y="670" class="mono">Lengths block (6×u32): L_off=N+1, L_nei=E, L_len=E, L_fl=E, L_pri=E, L_mm=E</text>

  <rect x="620" y="705" width="520" height="55" class="small"/>
  <text x="630" y="735" class="mono">offsets[L_off] • u32 (CSR; offsets[0]=0, offsets[N]=E)</text>

  <rect x="620" y="770" width="520" height="55" class="small"/>
  <text x="630" y="800" class="mono">neighbors[L_nei] • u32 (node index)</text>

  <rect x="620" y="835" width="520" height="55" class="small"/>
  <text x="630" y="865" class="mono">length_m[L_len] • float32 (meters; haversine)</text>

  <rect x="620" y="900" width="520" height="55" class="small"/>
  <text x="630" y="930" class="mono">surface_flags[L_fl] • u16 (bitmask; SurfaceTypes.hpp)</text>

  <rect x="620" y="965" width="520" height="55" class="small"/>
  <text x="630" y="995" class="mono">surface_primary[L_pri] • u8 (enum bucket)</text>

  <rect x="620" y="1030" width="520" height="55" class="small"/>
  <text x="630" y="1060" class="mono">mode_mask[L_mm] • u8 (bit0=BIKE, bit1=FOOT)</text>

  <!-- Legend chips -->
  <rect x="40" y="880" width="500" height="120" class="small"/>
  <text x="50" y="905" class="mono">Legend</text>

  <rect x="50" y="925" width="180" height="28" class="chip"/>
  <text x="60" y="944" class="mono">mode_mask bits</text>
  <text x="240" y="944" class="mono">0x01=BIKE • 0x02=FOOT</text>

  <rect x="50" y="960" width="220" height="28" class="chip"/>
  <text x="60" y="979" class="mono">surface_primary</text>
  <text x="280" y="979" class="mono">ASPHALT/CONCRETE/GRAVEL/…</text>

  <rect x="50" y="995" width="220" height="28" class="chip"/>
  <text x="60" y="1014" class="mono">surface_flags</text>
  <text x="280" y="1014" class="mono">bitset (PAVED, GRAVEL, …)</text>

  <!-- Footer -->
  <text x="40" y="1360" class="note">Notes: edges are directed and derived from WayMeta (bike/foot forward/back). Distances are great-circle; per-mode speeds/penalties are applied at routing time.</text>
</svg>
